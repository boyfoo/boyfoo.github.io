---
layout: post
title: 'go grpc'
date: 2021-03-12
author: boyfoo
tags: golang
---

##### 第三方包

```bash
$ go get google.golang.org/grpc
```

##### `prod.proto`文件示例

```proto
syntax = "proto3";
package services;
message ProdRequest {
  int32 prod_id = 1;
}
message ProdResponse {
  int32 prod_stock = 1;
}
service ProdService {
  rpc GetProdStock(ProdRequest) returns (ProdResponse);
}
```

生成文件；指定使用`plugins=grpc`插件，作用是生成`proto`文件时也生成定义的的`service`内容

```bash
protoc --go_out=plugins=grpc:[输出位置] [proto文件]
```

##### 创建结构体，实现接口

```golang
type ProdService struct{}

func (p *ProdService) GetProdStock(ctx context.Context, req *ProdRequest) (*ProdResponse, error) {
	return &ProdResponse{}, nil
}
```

##### 服务端提供`TCP`监听代码:

```golang
func main() {
	rpcServer := grpc.NewServer() // 创建grpc服务主体
	services.RegisterProdServiceServer(rpcServer, &services.ProdService{}) 	// 注册服务
	listen, _ := net.Listen("tcp", ":8081") // 监听tpc端口
	if err := rpcServer.Serve(listen); err != nil { // 使用监听的tpc端口运行服务
		log.Fatal(err)
	}
}
```

##### 客户端访问:

```golang
func main() {
	client, err := grpc.Dial(":8081", grpc.WithInsecure())	// grpc.WithInsecure() 不使用证书
	if err != nil {
		log.Fatal(err)
	}
	defer client.Close()
	prodClient := services.NewProdServiceClient(client)	// 获取客户端
	stock, err := prodClient.GetProdStock(context.Background(), &services.ProdRequest{ProdId: 100})	// 调用
	if err != nil {
		log.Fatal(err)
	}
	fmt.Println(stock.ProdStock)
}
```

##### 自签证书

```bash
$ mkdir certs && cd certs # 创建存放证书的目录
$ openssl 
> genrsa -des3 -out server.key 2048 # 生成私钥
Enter pass phrase for server.key:   #输入自定义秘钥
Verifying - Enter pass phrase for server.key: #再次输入自定义秘钥

> req -new -key server.key -out server.csr # 创建证书请求
Enter pass phrase for server.key: #输入上一步的自定义秘钥
Country Name (2 letter code) []:CN  # 国家
State or Province Name (full name) []:FJ #省
Locality Name (eg, city) []:XM  #市
Organization Name (eg, company) []:ZX #公司名称
Organizational Unit Name (eg, section) []:ZX  
Common Name (eg, fully qualified host name) []: # 名字或域名
Email Address []:zx358317301@qq.com # 邮箱
A challenge password []: # 直接回车

> x509 -req -days 365 -in server.csr -signkey server.key -out server.crt
Enter pass phrase for server.key: # 输入第一步的密码
```