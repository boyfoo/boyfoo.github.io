---
layout: post
title: '二进制部署 k8s'
date: 2020-10-22
author: boyfoo
tags: k8s
---

### 一、准备工作

#### 1.软件信息

* Docker version 18.06.3-ce
* CentOS 7.6.1811

#### 2.关闭防火墙

* centos

```bash
$ systemctl stop firewalld
$ systemctl disable firewalld
```

* ubuntu

`TODO`

#### 3.关闭交换分区

* centos

```bash
# 临时关闭
$ swapoff -a
```
```bash
# 永久关闭 注释文件内容
$ vim /etc/fstab
#/swapfile none swap defaults 0 0
```
```bash
#查看关闭结果
$ free -m
# Swap 都为0表示关闭成功
Swap:             0           0           0
```

* ubuntu

`TODO`

#### 4.配置主机名称名称解析

```bash
$ vim /etc/hosts

192.168.205.121 node02
192.168.205.120 node01
```


#### 5.关闭 setlinux

* centos

```bash
# 临时
$ setenforce 0

# 永久
$ vim /etc/selinux/config
SELINUX=disabled
```

* ubuntu

`TODO`

#### 6.配置时间

以主节点时间为准，副节点获取主节点的时间为准

* centos

主节点:

```bash
$ yum install chrony -y

$ vim /etc/chrony.conf
# 以本地时间地址 注释其他server
server 127.127.1.0 iburst
# 允许该网段的副接口来请求 集群的网段
allow 192.168.205.0/24
local stratum 10

$ systemctl restart chronyd
$ systemctl enable chronyd

# 查看进程端口是否被监听
$ ss -unl | grep 123
```

副节点:

```bash
$ yum install chrony -y

$ vim /etc/chrony.conf
# 以本地时间地址 注释其他server
server [主节点IP] iburst

$ systemctl restart chronyd
$ systemctl enable chronyd

# 查看结果 ^*开头表示成功
$ chronyc sources
^* node01                       10   6    17    41  +8305ns[  +54us] +/-  160us
```

* ubuntu

`TODO`

### 二、自签证书

#### 1.自建CA

方式有2种：
* openssl
* cfssl

`k8s` 官方推荐使用 `cfssl`

下载cfssl工具组件

```bash
$ curl -s -L -o /bin/cfssl https://pkg.cfssl.org/R1.2/cfssl_linux-amd64
$ curl -s -L -o /bin/cfssljson https://pkg.cfssl.org/R1.2/cfssljson_linux-amd64
$ curl -s -L -o /bin/cfssl-certinfo https://pkg.cfssl.org/R1.2/cfssl-certinfo_linux-amd64

# 赋予运行权限
$ chmod +x /bin/cfssl*
```
#### 2.颁发ECTD证书

文件统一生成在`/root/cfssl_file/`下

创建证书颁发机构：

`vim etcd/ca-csr.json`

```json
{
    "CN": "etcd CA",
    "key": {
        "algo": "rsa",
        "size": 2048
    },
    "names": [
        {
            "C": "CN",
            "L": "Beijing",
            "ST": "Beijing"
        }
    ]
}
```

`vim etcd/ca-config.json` 

```json
{
  "signing": {
    "default": {
      "expiry": "87600h"
    },
    "profiles": {
      "www": {
         "expiry": "87600h",
         "usages": [
            "signing",
            "key encipherment",
            "server auth",
            "client auth"
        ]
      }
    }
  }
}
```
<!-- tar xvf TLS.tar.gz -->

填写颁发表单：

`vim etcd/server-csr.json`

```json
{
    "CN": "etcd",
    "hosts": [
        "192.168.205.120",
        "192.168.205.121"
    ],
    "key": {
        "algo": "rsa",
        "size": 2048
    },
    "names": [
        {
            "C": "CN",
            "L": "BeiJing",
            "ST": "BeiJing"
        }
    ]
}
```

颁发证书:

```bash
$ cfssl gencert -initca ca-csr.json | cfssljson -bare ca -
$ cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=www server-csr.json | cfssljson -bare server

# 查看生成的证书文件 
ls *pem
```

安装`etcd`:

目前演示只在主机安装`etcd`，其他节点上只用`etcdcli`客户端，统一访问主节点的`etcd`，主节点生成证书启动后，证书要复制到其他节点上，供`etcdcli`客户端使用

```bash
$ yum install -y etcd-3.2.28-1.el7_8

# 查看系统脚本 修改ExecStart部分 和 证书配置文件
$ vim /usr/lib/systemd/system/etcd.service
[Unit]
Description=Etcd Server
After=network.target
After=network-online.target
Wants=network-online.target

[Service]
Type=notify
EnvironmentFile=/etc/etcd/etcd.conf
ExecStart=/usr/bin/etcd \
        --name=${ETCD_NAME} \
        --data-dir=${ETCD_DATA_DIR} \
        --listen-peer-urls=${ETCD_LISTEN_PEER_URLS} \
        --listen-client-urls=${ETCD_LISTEN_CLIENT_URLS},http://127.0.0.1:2379 \
        --advertise-client-urls=${ETCD_ADVERTISE_CLIENT_URLS} \
        --initial-advertise-peer-urls=${ETCD_INITIAL_ADVERTISE_PEER_URLS} \
        --initial-cluster=${ETCD_INITIAL_CLUSTER} \
        --initial-cluster-token=${ETCD_INITIAL_CLUSTER_TOKEN} \
        --initial-cluster-state=new \
        --cert-file=/root/cfssl_file/etcd/server.pem \
        --key-file=/root/cfssl_file/etcd/server-key.pem \
        --peer-cert-file=/root/cfssl_file/etcd/server.pem \
        --peer-key-file=/root/cfssl_file/etcd/server-key.pem \
        --trusted-ca-file=/root/cfssl_file/etcd/ca.pem \
        --peer-trusted-ca-file=/root/cfssl_file/etcd/ca.pem
Restart=on-failure
LimitNOFILE=65536

[Install]
WantedBy=multi-user.target
```

修改配置文件

```bash
$ vim /etc/etcd/etcd.conf
ETCD_LISTEN_PEER_URLS="https://192.168.205.120:2380"
ETCD_LISTEN_CLIENT_URLS="https://192.168.205.120:2379"
ETCD_ADVERTISE_CLIENT_URLS="https://192.168.205.120:2379"
ETCD_NAME="node01" # 节点名称
ETCD_INITIAL_ADVERTISE_PEER_URLS="https://192.168.205.120:2380"
ETCD_ADVERTISE_CLIENT_URLS="https://192.168.205.120:2379"
ETCD_INITIAL_CLUSTER="node01=https://localhost:2380"
ETCD_INITIAL_CLUSTER_TOKEN="etcd-cluster"
ETCD_INITIAL_CLUSTER_STATE="new"

systemctl daemon-reload
systemctl restart etcd.service
systemctl enable etcd.service
```

其他节点 `etcdcli` 客户端访问

先拷贝证书到节点上
```bash
scp -r /root/cfssl_file/etcd/ root@node02:/root/cfssl_file/etcd/
```

```bash
# 其他节点访问主机etcd
$ etcdctl --ca-file=/root/cfssl_file/etcd/ca.pem --cert-file=/root/cfssl_file/etcd/server.pem --key-file=/root/cfssl_file/etcd/server-key.pem --endpoints=https://192.168.205.120:2379 get zx

# 查看集群状态 (若失败要带上秘钥)
$ etcdctl --endpoints=https://192.168.205.120:2379 cluster-health
```