---
layout: post
title: '4.mysql 备份'
date: 2020-12-21
author: boyfoo
tags: mysql
---

流程步骤:
1. 每个数据库示例 server_id,server_uuid
2. 主库开启二进制日志
3. 主库中创建专用的复制用户(replication slave)
4. 主库全备，导入从库
5. 告诉从库谁是主库，从哪里开始复制
6. 从库开启复制线程


每个库都新增唯一标识符:
```bash
server_id=xxx
```

主数据库配置 开启二进制日志:

```bash
log_bin=/var/log/mysql/mysql-bin-log.log
```

主数据库新增复制用户:

```mysql
#账号repl 密码 123456
mysql> grant replication slave on *.* to repl@'%' identified by '123456';
```

导出主库全备信息，获得备份文件 `full.sql`:

```bash
$ mysqldump -uroot -proot --triggers -R -E --master-data=2 --single-transaction -A > /var/log/mysql/full.sql
```

打开备份文件，记下此处注释内容，后面需要用到
```bash
-- CHANGE MASTER TO MASTER_LOG_FILE='{MASTER_LOG_FILE}', MASTER_LOG_POS={MASTER_LOG_POS};
```

连接上所有的从库执行:

```mysql
mysql> set sql_log_bin=0;
mysql> source /var/log/mysql/full.sql;
mysql> set sql_log_bin=1;
```

此时旧数据已经同步，开始`binlog`日志同步

继续在从库上执行:

```mysql
# 连接主节点
mysql> CHANGE MASTER TO
  MASTER_HOST='mysql01',
  MASTER_USER='repl',   
  MASTER_PASSWORD='123456',
  MASTER_PORT=3306,
  MASTER_LOG_FILE='mysql-bin-log.000003', 
  MASTER_LOG_POS=1641,
  MASTER_CONNECT_RETRY=10;
  
# 开启同步线程
mysql> start slave;

# 查看状态
mysql> show slave status \G;
# Slave_IO_State: Connecting to master
#                   Master_Host: mysql01
#                   Master_User: repl
#                   Master_Port: 3306
#               Master_Log_File: mysql-bin-log.000003   

#           Read_Master_Log_Pos: 1829   当前从库已经复制的二进制日志位置
#                Relay_Log_File: 2783faf5c6dc-relay-bin.000001  从库的中继日志状态
#                 Relay_Log_Pos: 4

#              Slave_IO_Running: YES 从库复制线程的状态
#             Slave_SQL_Running: Yes
#                 Last_IO_Errno:    # 错误原因
#                 Last_IO_Error:
#                Last_SQL_Errno: 0
#                Last_SQL_Error:
#         Seconds_Behind_Master: NULL  #当前造成的原因主从延迟秒(被动延迟的)
#
#                     SQL_Delay: 0    # 主动设置的延迟时间
#           SQL_Remaining_Delay: NULL
#
#            Retrieved_Gtid_Set:        # gtid复制状态
#            Executed_Gtid_Set:
#                Auto_Position: 0
```
