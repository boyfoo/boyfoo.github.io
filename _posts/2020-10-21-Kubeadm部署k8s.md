---
layout: post
title: 'Rancher2部署k8s'
date: 2020-10-21
author: boyfoo
tags: k8s
---

#### 关闭防火墙

```bash
$ systemctl stop firewalld && systemctl disable firewalld
```
#### 关闭 SElinux

```bash
# 临时关闭 重启无效
$ setenforce 0 
```

#### 关闭 swap

```bash
$ swapoff -a
$ sed -ri "s/.*swap.*/#&/" /etc/fstab
```

#### 桥接IPV4流量传递到iptables的链

```bash
cat > /etc/sysctl.d/k8s.conf << EOF
net.bridge.bridge-nf-call-ip6tables = 1
net.bridge.bridge-nf-call-iptables = 1
EOF

# 刷新生效
sudo sysctl --system
```


#### 官方安装方式

各节点安装

https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/install-kubeadm/


安装 
```
kubelet-1.19.3 kubeadm-1.19.3 kubectl-1.19.3
```

只设置kubelet开机启动
```
sudo systemctl enable kubelet
```

此处不要手动启动 `kubelet`，使用 `kubeadm` 去启动


#### 加入

主节点创建
```bash
sudo kubeadm init --apiserver-advertise-address=192.168.10.10 --image-repository registry.aliyuncs.com/google_containers --kubernetes-version v1.19.3 --service-cidr=10.1.0.0/16 --pod-network-cidr=10.244.0.0/16
```

生成的配置文件 `/etc/kubernetes/`

根据命令框提示，复制admin配置文件 到 `~/.kube/`

```bash 
mkdir -p $HOME/.kube
sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
sudo chown $(id -u):$(id -g) $HOME/.kube/config
```

查看当前node节点
```bash
kubectl get node
```

理应有当前一台，状态为NotReady，因为还没有容器网络


安装flannel网络，下载kube-flannel.yml文件到本地
https://github.com/coreos/flannel/blob/master/Documentation/kube-flannel.yml
```bash
kubectl apply -f kube-flannel.yml
```

等一会儿
```bash
kubectl get node
```

已经是`ready`状态


查询系统pods状态
```bash
kubectl get pods -n kube-system
```

`kube-flannel-ds***` 已经是run状态


#### node加入

使用`kubuadm init`后命令返回最后的指令在其他节点上运行

```bash
kubeadm join xxxxx
```

#### 使用

运行一个名字为nginx01的控制器 使用镜像为nginx
```bash
kubectl create deployment nginx01 --image=nginx

kubectl expose deployment nginx01 --port=80 --type=NodePort
```

获取状态

```bash
kubectl get pods,svc -o wide
```
