---
layout: post
title: '奇特的 sql'
date: 2020-08-02
author: boyfoo
tags: mysql
---

#### 新增行号 @rownum 

```sql

# 行号字段每行数据会自动加一
# 在`from`区域设置行号初始化为0

mysql> select 
    p_name, p_type ,p_view,(@rownum := @rownum + 1) 
as rownum from products a,
   (select @rownum:=0) b 
ORDER BY p_view DESC
```

根据类型分组，并按照浏览数排序，取出每个类型浏览最多的2行数据

```sql
# 最内部的子查询，先将数据按照类型浏览量排序，并且设置初始rownum bak 值
# 在根据每个不同类型名称，标上序号
# 最后根据内部子查询结果为表，查询出序号小于2的，为前2条数据
mysql> select p_type, p_name,p_view , num from (

select p_type, p_name, p_view , if (@bak=p_type, @rownum := @rownum + 1, @rownum := 1) as num, @bak:= p_type from 

(select p_name,p_type,p_view FROM products ORDER BY p_type,p_view DESC) a , (select @rownum:= 0, @bak:='') b ) c

where c.num <=2
```